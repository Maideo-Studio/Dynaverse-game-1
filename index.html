<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Three.js Multiplayer with Scaledrone</title>
    <style>
        body { margin: 0; overflow: hidden; background: #2595f3; }
        canvas { display: block; }
          body {
    margin: 0;
  }

  #flashImage {
    position: fixed;              /* stays in screen center */
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%); /* true center */
    width: 200px;
  }
    </style>
</head>
<body>




<img id="flashImage" src="https://cdn.pixabay.com/animation/2025/12/14/21/30/21-30-32-171_512.gif">



<script>
  // Hide after 0.5 seconds (500 milliseconds)
  setTimeout(() => {
    document.getElementById("flashImage").style.display = "none";
  }, 1000);
</script>




<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.scaledrone.com/scaledrone.min.js"></script>

<script>
   
class MultiplayerEngine {
    constructor() {
            this.item = 0;
        this.walkSoundPlaying = false;
        this.keys = {};
        this.speed = 0.15;
        this.rotationSpeed = 0.05;
        this.cameraAngle = 0;
        this.cameraDistance = 8;
        this.cameraHeight = 4;
this.jumpSound = new Audio("https://raw.githubusercontent.com/Maideo-Studio/Dynaversesounds/main/roblox-classic-jump.mp3");
this.walkSound = new Audio("https://raw.githubusercontent.com/Maideo-Studio/Dynaversesounds/main/walk.mp3");
        this.isJumping = false;
        this.velocity_y = 0;
        this.gravity = -0.05;
        this.jumpStrength = 0.8;

        this.players = {};
        this.clientId = Math.random().toString(36).substring(2, 10);

        this.initScene();
        this.initCamera();
        this.initRenderer();
        this.initLights();
        this.initObjects();
        this.initControls();
        this.addResizeListener();
        this.initScaledrone();
        this.animate();
    }

    initScene() {
        this.scene = new THREE.Scene();
        this.scene.background = new THREE.Color(0x2595f3);
    }

    initCamera() {
        this.camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 70000000);
    }

    initRenderer() {
        this.renderer = new THREE.WebGLRenderer({ antialias: true });
        this.renderer.setSize(window.innerWidth, window.innerHeight);
        this.renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(this.renderer.domElement);
    }

    initLights() {
        const ambient = new THREE.AmbientLight(0xffffff, 1.5);
        this.scene.add(ambient);
        const directional = new THREE.DirectionalLight(0xffffff, 2);
        directional.position.set(5, 10, 5);
        this.scene.add(directional);
    }

    initObjects() {
        const loader = new THREE.TextureLoader();

        // Ground
        const groundTexture = loader.load("https://raw.githubusercontent.com/Maideo-Studio/Dynaverse-faces/main/roblox-stud%20(1).png");
        groundTexture.wrapS = groundTexture.wrapT = THREE.RepeatWrapping;
        groundTexture.repeat.set(100, 100);
        groundTexture.magFilter = THREE.NearestFilter;
        const groundMat = new THREE.MeshStandardMaterial({ map: groundTexture});
        const groundGeo = new THREE.PlaneGeometry(100, 100);
        this.ground = new THREE.Mesh(groundGeo, groundMat);
        this.ground.rotation.x = -Math.PI / 2;
        this.ground.position.y = -1.1;
        this.scene.add(this.ground);



        const ground2Texture = loader.load("https://raw.githubusercontent.com/Maideo-Studio/Dynaverse-faces/main/roblox-stud%20(1).png");
        ground2Texture.wrapS = ground2Texture.wrapT = THREE.RepeatWrapping;
        ground2Texture.repeat.set(100, 10);
        ground2Texture.magFilter = THREE.NearestFilter;
        const ground2Mat = new THREE.MeshStandardMaterial({ map: ground2Texture, color: 0x00FF00});
        const ground2Geo = new THREE.PlaneGeometry(100, 10);
        this.ground2 = new THREE.Mesh(ground2Geo, ground2Mat);
        this.ground2.rotation.x = -Math.PI / 2;
        this.ground2.position.y = -1.099;
                this.ground2.position.z = 45;
        this.scene.add(this.ground2);









        // Obstacles & boxes
        const boxGeo = new THREE.BoxGeometry(7, 9, 1);
        const textureLoader = new THREE.TextureLoader();
        const texture = textureLoader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/main/6c73f79e-38f2-4f6e-aab7-d66f7f1755de.png");
        texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
        texture.repeat.set(1, 1);
        const boxMat = new THREE.MeshStandardMaterial({ map: texture, color: 0xC4A484 });
        this.customBox = new THREE.Mesh(boxGeo, boxMat);
        this.customBox.position.set(-15.2, 1, -6);
        this.scene.add(this.customBox);

        const boxGeo2 = new THREE.BoxGeometry(10, 8, 0.0001);
        const texture2 = textureLoader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/da678efa-e4a2-4312-9c8d-d73561806de0.png");
        const boxMat2 = new THREE.MeshStandardMaterial({ map: texture2 });
        this.secondBox = new THREE.Mesh(boxGeo2, boxMat2);
        this.secondBox.position.set(5, 3, -10);
        this.scene.add(this.secondBox);

        const boxGeo3 = new THREE.BoxGeometry(3, 3, 0.001);
        const texture3 = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/4c5ab58e-c8a2-483d-ba77-8d2d212b61ca.png");
        texture3.wrapS = texture3.wrapT = THREE.RepeatWrapping;
        texture3.repeat.set(1, 1);
        texture3.magFilter = THREE.NearestFilter;
        const boxMat3 = new THREE.MeshStandardMaterial({ map: texture3 });
        this.thirdBox = new THREE.Mesh(boxGeo3, boxMat3);
        this.thirdBox.position.set(-10, 1.5, -4.9);
        this.scene.add(this.thirdBox);
        
           const boxGeo4 = new THREE.BoxGeometry(16, 2, 1);
        const texture4 = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/dd7e7ed6-c3cf-4c3b-8fcb-7f94ce00f49a.png");
        texture4.wrapS = texture4.wrapT = THREE.RepeatWrapping;
        texture4.repeat.set(1, 1);
        texture4.magFilter = THREE.NearestFilter;
        const boxMat4 = new THREE.MeshStandardMaterial({ map: texture4 });
        this.fourthBox = new THREE.Mesh(boxGeo4, boxMat4);
        this.fourthBox.position.set(-15, 0, -13);
        this.scene.add(this.fourthBox);

        
// 1. Smoother geometry
const boxGeo5 = new THREE.BoxGeometry(500000000, 2000000, 500000000); // Increased size to 50 so it's a large sky dome

// 2. Texture loading
const texture5 = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/ylanite-clouds-5514993_1920.jpg");
texture5.wrapS = texture5.wrapT = THREE.RepeatWrapping;
texture5.repeat.set(5, 5);
texture5.magFilter = THREE.LinearFilter; 

// 3. Material and Mesh
const boxMat5 = new THREE.MeshStandardMaterial({ 
    map: texture5,
    roughness: 1,
    side: THREE.DoubleSide // <--- THIS MAKES THE TEXTURE VISIBLE FROM THE INSIDE
});

this.fifthBox = new THREE.Mesh(boxGeo5, boxMat5);
this.fifthBox.position.set(0, 0, 0);

this.scene.add(this.fifthBox);






const boxGeo6 = new THREE.BoxGeometry(65000000000000000000000000000000000000, 3000000000000000000000000000000000000, 6500000000000000000000000000000000000000);


const texture6 = loader.load("");
texture6.wrapS = texture5.wrapT = THREE.RepeatWrapping;
texture6.repeat.set(5, 5);
texture6.magFilter = THREE.LinearFilter; 


const boxMat6 = new THREE.MeshStandardMaterial({ 
    map: texture6,
    roughness: 1,
       side: THREE.DoubleSide 
});

this.sixthBox = new THREE.Mesh(boxGeo6, boxMat6);
this.sixthBox.position.set(0, 0, 0);
  
this.scene.add(this.sixthBox);



const boxGeo7 = new THREE.BoxGeometry(700000000000000000000000000000000000000, 30000000000000000000000000000000000000, 70000000000000000000000000000000000000000);


const texture7 = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/gdj-tunnel-7626014_1920.png");
texture7.wrapS = texture5.wrapT = THREE.RepeatWrapping;
texture7.repeat.set(5, 5);
texture7.magFilter = THREE.LinearFilter; 


const boxMat7 = new THREE.MeshStandardMaterial({ 
    map: texture7,
    roughness: 1,
       side: THREE.DoubleSide 
});

this.seventhBox = new THREE.Mesh(boxGeo7, boxMat7);
this.seventhBox.position.set(0, 0, 0);
  
this.scene.add(this.seventhBox);




// 1. Smoother geometry
const boxGeo8 = new THREE.BoxGeometry(1, 1, 0.001); // Increased size to 50 so it's a large sky dome

// 2. Texture loading
const texture8 = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/00aed48c-afec-47c5-ba3b-c3f107e4298a%20(1).png");
texture8.wrapS = texture5.wrapT = THREE.RepeatWrapping;
texture8.repeat.set(1, 1);
texture8.magFilter = THREE.LinearFilter; 

// 3. Material and Mesh
const boxMat8 = new THREE.MeshStandardMaterial({ 
    map: texture8,
    roughness: 1,
    side: THREE.DoubleSide
});

this.eigthBox = new THREE.Mesh(boxGeo8, boxMat8);
this.eigthBox.position.set(-18, 1.45, -13);

this.scene.add(this.eigthBox);











        // Player
        this.player = new THREE.Group();
        this.player.position.y = 0.5;
        this.scene.add(this.player);

        const geometry = new THREE.BoxGeometry();
        const faceTexture = loader.load("https://raw.githubusercontent.com/Maideo-Studio/Dynaverse-faces/main/76baf281-4d65-4780-bbec-a7f7b27c9ae7.png");
        faceTexture.magFilter = THREE.NearestFilter;

        const headMaterials = [
            new THREE.MeshStandardMaterial({ color: 0xd524b0 }),
            new THREE.MeshStandardMaterial({ color: 0xd524b0 }),
            new THREE.MeshStandardMaterial({ color: 0xd524b0 }),
            new THREE.MeshStandardMaterial({ color: 0xd524b0 }),
            new THREE.MeshStandardMaterial({ map: faceTexture, color: 0xfc55cc }),
            new THREE.MeshStandardMaterial({ color: 0xd524b0 })
        ];
        this.head = new THREE.Mesh(geometry, headMaterials);
        this.head.scale.set(1.5, 1, 1);
        this.player.add(this.head);

        const bodyMat = new THREE.MeshStandardMaterial({ color: 0x990099 });
        this.body = new THREE.Mesh(geometry, bodyMat);
        this.body.position.set(0, -0.8, 0);
        this.body.scale.set(0.6, 0.6, 0.5);
        this.player.add(this.body);

        const limbMat = new THREE.MeshStandardMaterial({ color: 0xd524b0 });
        this.leftArm = new THREE.Mesh(geometry, limbMat);
        this.leftArm.position.set(-0.41, -0.8, 0);
        this.leftArm.scale.set(0.2, 0.6, 0.3);
        this.player.add(this.leftArm);

        this.rightArm = new THREE.Mesh(geometry, limbMat);
        this.rightArm.position.set(0.41, -0.8, 0);
        this.rightArm.scale.set(0.2, 0.6, 0.3);
        this.player.add(this.rightArm);

        this.leftLeg = new THREE.Mesh(geometry, limbMat);
        this.leftLeg.position.set(-0.2, -1.3, 0);
        this.leftLeg.scale.set(0.2, 0.6, 0.3);
        this.player.add(this.leftLeg);

        this.rightLeg = new THREE.Mesh(geometry, limbMat);
        this.rightLeg.position.set(0.2, -1.3, 0);
        this.rightLeg.scale.set(0.2, 0.6, 0.3);
        this.player.add(this.rightLeg);






// --- NEW TEXTURED CUBE ---
const newBoxGeo = new THREE.BoxGeometry(7, 4, 0.001); // width, height, depth
const newTexture = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/e7bd7d50-1c14-4a5c-a9c3-1924386c3e0d.png"); // replace with your texture
newTexture.wrapS = newTexture.wrapT = THREE.RepeatWrapping;
newTexture.repeat.set(1, 1);
newTexture.magFilter = THREE.NearestFilter;

const newBoxMat = new THREE.MeshStandardMaterial({
    map: newTexture,
    color: 0xFFFFFF // change this to adjust darkness
});

this.newBox = new THREE.Mesh(newBoxGeo, newBoxMat);





// Position the cube somewhere in the scene
this.newBox.position.set(-15, 5, -17); // x, y, z

// Add it to the scene
this.scene.add(this.newBox);











        // Obstacles (same as original)
        const obstacleTexture = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/main/image%20(5).png");
        obstacleTexture.magFilter = THREE.NearestFilter;
        obstacleTexture.wrapS = obstacleTexture.wrapT = THREE.RepeatWrapping;
        obstacleTexture.repeat.set(0.3, 0.3);

        const obstacleGeo = new THREE.BoxGeometry(1, 2, 2);
        const obstacleMat = new THREE.MeshStandardMaterial({ map: obstacleTexture });

        this.obstacles = [];
        const obstaclePositions = [
                      [-6, 0, -10],
            [-6, 0, -12],
            [-6, 0, -14],
            [-6, 0, -16],
            [-6, 0, -18],
            [-7, 0, -18],
            [-8, 0, -18],
            [-8, 2, -18],
            [-8, 4, -18],
            [-8, 6, -18],
             [-8, 8, -18],
              [-7, 8, -18],
                [-6, 8, -18],
                  [-6, 7, -18],
                    [-7, 6, -18],
                     [-7, 5, -18],
                      [-7, 4, -18],
                       [-7, 2, -18],
                        [-7, 0, -18],
                             [-6, 0, -18],
                             [-6, 2, -18],
                                 [-6, 4, -18],
      [-6, 6, -18],
              [-6, 0, -8],
                          [-6, 0, -6],
                        [-6, 2, -10],
                         [-6, 4, -10],
                          [-6, 6, -10],
                           [-6, 8, -10],
                 [-6, 2, -12],
                    [-6, 4, -12],
                               [-6, 6, -12],
                                          [-6, 8, -12],
                                                   [-6, 8, -14],
      [-6, 6, -14],
            [-6, 4, -14],
                  [-6, 2, -14],
                    [-6, 2, -16],
                                        [-6, 4, -16],
                                        [-6, 6, -16],
                                        [-6, 8, -16],
                                        [-6, 8, -8],
                    [-6, 6, -8],
                    [-6, 4, -8],
                    [-6, 2, -8],
                                                            [-6, 8, -6],
                    [-6, 6, -6],
                    [-6, 4, -6],
                    [-6, 2, -6],
                            [-7, 2, -6],
                                   [-7, 0, -6],
                                   [-7, 4, -6],
                                   [-7, 6, -6],
                                   [-7, 8, -6],
    [-8, 8, -6],
    [-8, 6, -6],
    [-8, 4, -6],
    [-8, 2, -6],
    [-8, 0, -6],
    
        [-9, 8, -6],
    [-9, 6, -6],
    [-9, 4, -6],
    [-9, 2, -6],
    [-9, 0, -6],
    
            [-10, 8, -6],
    [-10, 6, -6],
    [-10, 4, -6],
    [-10, 2, -6],
    [-10, 0, -6],
    
                [-11, 8, -6],
    [-11, 6, -6],
    [-11, 4, -6],
    [-11, 2, -6],
    [-11, 0, -6],
    
                    [-12, 8, -6],
    [-12, 6, -6],
    [-12, 4, -6],
    [-12, 2, -6],
    [-12, 0, -6],
    
        [-13, 4, -6],
             [-14, 5, -6],
                    [-15, 5, -6],
         
                                          [-17,4, -6],
                [-17,2, -6],
                      [-17,4, -6],
                         [-17,0, -6],
                            [-17,6, -6],
                               [-17,8, -6],
                               [-16,8, -6],
                                  [-16,6, -6],
                                  [-16,6, -6],
                                       [-16,5, -6],
                                            [-16,4, -6],
                                                      [-15,6, -6],
                                            
                                                         [-15,8, -6],
                                                         [-14,8, -6],
                                                         [-14,6, -6],
                                                         [-13,6, -6],
                                                         [-13,8, -6],
                        [-18 ,8, -6],
                                [-18 ,6, -6],
                                [-18 ,4, -6],
                                         [-18 ,2, -6],
                                [-18 ,0, -6],
                                
                                               [-19 ,8, -6],
                                [-19 ,6, -6],
                                [-19 ,4, -6],
                                      [-19 ,2, -6],
                                [-19 ,0, -6],
                                [-20 ,0, -6],
                                [-20 ,2, -6],
                                [-20 ,4, -6],
                                [-20 ,6, -6],
                                [-20 ,8, -6],
                                
                                   [-21 ,0, -6],
                                [-21 ,2, -6],
                                [-21 ,4, -6],
                                [-21 ,6, -6],
                                [-21 ,8, -6],
                                
                                     [-22 ,0, -6],
                                [-22 ,2, -6],
                                [-22 ,4, -6],
                                [-22 ,6, -6],
                                [-22 ,8, -6],
                                
                                         [-23 ,0, -6],
                                [-23 ,2, -6],
                                [-23 ,4, -6],
                                [-23 ,6, -6],
                                [-23 ,8, -6],
                                
                                   
                                                [-23 ,0, -7],
                                [-23 ,2, -7],
                                [-23 ,4, -7],
                                [-23 ,6, -7],
                                [-23 ,8, -7],
                                
                                                                                [-23 ,0, -8],
                                [-23 ,2, -8],
                                [-23 ,4, -8],
                                [-23 ,6, -8],
                                [-23 ,8, -8],
                                                                                [-23 ,0, -9],
                                [-23 ,2, -9],
                                [-23 ,4, -9],
                                [-23 ,6, -9],
                                [-23 ,8, -9],
                                
                                 [-23 ,0, -10],
                                [-23 ,2, -10],
                                [-23 ,4, -10],
                                [-23 ,6, -10],
                                [-23 ,8, -10],
                                
                                 [-23 ,0, -11],
                                [-23 ,2, -11],
                                [-23 ,4, -11],
                                [-23 ,6, -11],
                                [-23 ,8, -11],
                                
                                 [-23 ,0, -12],
                                [-23 ,2, -12],
                                [-23 ,4, -12],
                                [-23 ,6, -12],
                                [-23 ,8, -12],
                                
                                 [-23 ,0, -13],
                                [-23 ,2, -13],
                                [-23 ,4, -13],
                                [-23 ,6, -13],
                                [-23 ,8, -13],
                                
                                 [-23 ,0, -14],
                                [-23 ,2, -14],
                                [-23 ,4, -14],
                                [-23 ,6, -14],
                                [-23 ,8, -14],
                                
                                 [-23 ,0, -15],
                                [-23 ,2, -15],
                                [-23 ,4, -15],
                                [-23 ,6, -15],
                                [-23 ,8, -15],
                                
                                 [-23 ,0, -16],
                                [-23 ,2, -16],
                                [-23 ,4, -16],
                                [-23 ,6, -16],
                                [-23 ,8, -16],
                                
                                                      [-23 ,0, -17],
                                [-23 ,2, -17],
                                [-23 ,4, -17],
                                [-23 ,6, -17],
                                [-23 ,8, -17],
                                               
                                               
                                              [-23 ,0, -18],
                                [-23 ,2, -18],
                                [-23 ,4, -18],
                                [-23 ,6, -18],
                                [-23 ,8, -18],
                                
                                       [-22 ,0, -18],
                                [-22 ,2, -18],
                                [-22 ,4, -18],
                                [-22 ,6, -18],
                                [-22 ,8, -18],
                                
                                                  [-21 ,0, -18],
                                [-21 ,2, -18],
                                [-21 ,4, -18],
                                [-21 ,6, -18],
                                [-21 ,8, -18],
                                
                                                     [-20 ,0, -18],
                                [-20 ,2, -18],
                                [-20 ,4, -18],
                                [-20 ,6, -18],
                                [-20 ,8, -18],
                                
                                                     [-19 ,0, -18],
                                [-19 ,2, -18],
                                [-19 ,4, -18],
                                [-19 ,6, -18],
                                [-19 ,8, -18],
                                
                                                     [-18 ,0, -18],
                                [-18 ,2, -18],
                                [-18 ,4, -18],
                                [-18 ,6, -18],
                                [-18 ,8, -18],
                                
                                                 [-17 ,0, -18],
                                [-17 ,2, -18],
                                [-17 ,4, -18],
                                [-17 ,6, -18],
                                [-17 ,8, -18],
                                
                                   [-16 ,0, -18],
                                [-16 ,2, -18],
                                [-16 ,4, -18],
                                [-16 ,6, -18],
                                [-16 ,8, -18],
                                
                                             [-15 ,0, -18],
                                [-15 ,2, -18],
                                [-15 ,4, -18],
                                [-15 ,6, -18],
                                [-15 ,8, -18],
                                
                                                     [-14 ,0, -18],
                                [-14 ,2, -18],
                                [-14 ,4, -18],
                                [-14 ,6, -18],
                                [-14 ,8, -18],
                                
                                                     [-13 ,0, -18],
                                [-13 ,2, -18],
                                [-13 ,4, -18],
                                [-13 ,6, -18],
                                [-13 ,8, -18],
                                
                                                     [-12 ,0, -18],
                                [-12 ,2, -18],
                                [-12 ,4, -18],
                                [-12 ,6, -18],
                                [-12 ,8, -18],
                                
                                                     [-11 ,0, -18],
                                [-11 ,2, -18],
                                [-11 ,4, -18],
                                [-11 ,6, -18],
                                [-11 ,8, -18],
                                
                                                     [-10 ,0, -18],
                                [-10 ,2, -18],
                                [-10 ,4, -18],
                                [-10 ,6, -18],
                                [-10 ,8, -18],
                         
                                                     [-9 ,0, -18],
                                [-9 ,2, -18],
                                [-9 ,4, -18],
                                [-9 ,6, -18],
                                [-9 ,8, -18],
                                
                                            [-8 ,0, -18],
                                [-9 ,2, -18],
                                [-9 ,4, -18],
                                [-9 ,6, -18],
                                [-9 ,8, -18]
            // ... truncated for brevity, keep all original positions
        ];
   const obstacle2Texture = loader.load("https://raw.githubusercontent.com/Maideo-Studio/textures/refs/heads/main/image%20(6).png");
        obstacle2Texture.magFilter = THREE.NearestFilter;
        obstacle2Texture.wrapS = obstacle2Texture.wrapT = THREE.RepeatWrapping;
        obstacle2Texture.repeat.set(1, 1); // make texture appear bigger

        const obstacle2Geo = new THREE.BoxGeometry(18, 1, 14 );
        const obstacle2Mat = new THREE.MeshStandardMaterial({ map: obstacle2Texture });

        this.obstacle2s = [];

        const obstacle2Positions = [
            [-14.5,9.5,-12]
    ];
        obstacle2Positions.forEach(pos => {
    const obstacle = new THREE.Mesh(obstacle2Geo, obstacle2Mat);

    obstacle.position.set(pos[0], pos[1], pos[2]);

    this.scene.add(obstacle);   // or scene.add(obstacle) depending on your setup
    this.obstacle2s.push(obstacle);
});
        for (let pos of obstaclePositions) {
            const obs = new THREE.Mesh(obstacleGeo, obstacleMat);
            obs.position.set(pos[0], pos[1], pos[2]);
            this.scene.add(obs);
            this.obstacles.push(obs);
        }

        // Boxes for collision
        this.playerBox = new THREE.Box3();
        this.obstacleBoxes = this.obstacles.map(() => new THREE.Box3());
    }

 


    // ===== NEW: Shorter Head Hitbox =====
    updatePlayerHitbox() {
        const pos = this.player.position;
        const min = new THREE.Vector3(pos.x - 0.75, pos.y - 1.3, pos.z - 0.25);
        const max = new THREE.Vector3(pos.x + 0.75, pos.y + 1.0, pos.z + 0.25); // shorter head
        this.playerBox.min.copy(min);
        this.playerBox.max.copy(max);
    }

    initControls() {
        window.addEventListener("keydown", (e) => this.keys[e.key.toLowerCase()] = true);
        window.addEventListener("keyup", (e) => this.keys[e.key.toLowerCase()] = false);
    }

    initScaledrone() {
        this.drone = new Scaledrone("NUQmTa8yqYMpijoa");
        this.drone.on('open', () => {
            console.log("Connected to Scaledrone");
            this.room = this.drone.subscribe("observable-room");
            this.room.on('data', (data) => {
                if (data.id === this.clientId) return;
                if (!this.players[data.id]) this.players[data.id] = this.createRemotePlayer();
                this.players[data.id].position.set(data.x, data.y, data.z);
                this.players[data.id].rotation.y = data.rotationY;
            });
        });
    }

    createRemotePlayer() {
        const geometry = new THREE.BoxGeometry();
        const headMat = new THREE.MeshStandardMaterial({ color: 0xff00ff });
        const bodyMat = new THREE.MeshStandardMaterial({ color: 0x990099 });
        const limbMat = new THREE.MeshStandardMaterial({ color: 0xd524b0 });

        const group = new THREE.Group();
        const head = new THREE.Mesh(geometry, headMat);
        head.scale.set(1.5, 1, 1);
        group.add(head);

        const body = new THREE.Mesh(geometry, bodyMat);
        body.position.set(0, -0.8, 0);
        body.scale.set(0.6, 0.6, 0.5);
        group.add(body);

        const leftArm = new THREE.Mesh(geometry, limbMat);
        leftArm.position.set(-0.41, -0.8, 0);
        leftArm.scale.set(0.2, 0.6, 0.3);
        group.add(leftArm);

        const rightArm = new THREE.Mesh(geometry, limbMat);
        rightArm.position.set(0.41, -0.8, 0);
        rightArm.scale.set(0.2, 0.6, 0.3);
        group.add(rightArm);

        const leftLeg = new THREE.Mesh(geometry, limbMat);
        leftLeg.position.set(-0.2, -1.3, 0);
        leftLeg.scale.set(0.2, 0.6, 0.3);
        group.add(leftLeg);

        const rightLeg = new THREE.Mesh(geometry, limbMat);
        rightLeg.position.set(0.2, -1.3, 0);
        rightLeg.scale.set(0.2, 0.6, 0.3);
        group.add(rightLeg);

        this.scene.add(group);
        return group;
    }

    updateMovement() {
// Update player hitbox
this.updatePlayerHitbox();

// Check collision with obstacle 8
const obstacle8Box = new THREE.Box3().setFromObject(this.eigthBox);
if (this.playerBox.intersectsBox(obstacle8Box)) {
    if (this.keys["p"]) {
    this.item = 1; // player touched obstacle 8
    }
} 
// Update inventory display
const inventoryImg = document.getElementById("inventoryItem");
inventoryImg.style.display = this.item === 1 ? "block" : "none";


        const forward = new THREE.Vector3();
        this.camera.getWorldDirection(forward);
        forward.y = 0;
        forward.normalize();

        const right = new THREE.Vector3();
        right.crossVectors(forward, new THREE.Vector3(0,1,0)).normalize();

        let moved = false;
        const oldPosition = this.player.position.clone();

        if (this.keys["w"]) { this.player.position.add(forward.clone().multiplyScalar(this.speed)); moved = true;
         // Play walk sound
    this.walkSound.play();
 }
        if (this.keys["s"]) { this.player.position.add(forward.clone().multiplyScalar(-this.speed)); moved = true; 
        // Play walk sound
    this.walkSound.play()
}
        if (this.keys["a"]) { this.player.position.add(right.clone().multiplyScalar(-this.speed)); moved = true; 
        // Play walk sound
    this.walkSound.play()
}
        if (this.keys["d"]) { this.player.position.add(right.clone().multiplyScalar(this.speed)); moved = true; 
        // Play walk sound
    this.walkSound.play()
}

        // Horizontal collisions
        this.updatePlayerHitbox(); // ✅ use custom shorter hitbox
        this.obstacles.forEach((obs, i) => this.obstacleBoxes[i].setFromObject(obs));
        if (this.obstacleBoxes.some(box => this.playerBox.intersectsBox(box))) {
            this.player.position.copy(oldPosition);
        }

        // Jumping
        if (this.keys[" "] && !this.isJumping) {
            this.velocity_y = this.jumpStrength;
            this.isJumping = true;
            
                 // Play jump sound
    this.jumpSound.currentTime = 0; // reset if already playing
    this.jumpSound.play();
        }

        this.player.position.y += this.velocity_y;
        this.velocity_y += this.gravity;

        this.updatePlayerHitbox(); // ✅ update hitbox after vertical movement
        this.obstacles.forEach((obs, i) => this.obstacleBoxes[i].setFromObject(obs));

        // Landing on obstacles
        for (let i = 0; i < this.obstacles.length; i++) {
            let obs = this.obstacles[i];
            let box = this.obstacleBoxes[i];
            if (this.playerBox.intersectsBox(box) && this.velocity_y <= 0) {
                const obstacleTop = obs.position.y + 1;
                this.player.position.y = obstacleTop + 1.35;
                this.velocity_y = 0;
                this.isJumping = false;
            }
        }

        // Floor
        const halfSize = 50;
        const onGroundArea =
            this.player.position.x > -halfSize &&
            this.player.position.x < halfSize &&
            this.player.position.z > -halfSize &&
            this.player.position.z < halfSize;

        if (onGroundArea && this.player.position.y < 0.5) {
            this.player.position.y = 0.5;
            this.isJumping = false;
            this.velocity_y = 0;
        }

        // Player rotation
        if (moved) {
            const velocity = new THREE.Vector3(0,0,0);
            if (this.keys["w"]) velocity.add(forward);
            if (this.keys["s"]) velocity.add(forward.clone().negate());
            if (this.keys["a"]) velocity.add(right.clone().negate());
            if (this.keys["d"]) velocity.add(right);
            if (velocity.lengthSq() > 0) {
                velocity.normalize();
                this.player.lookAt(this.player.position.clone().add(velocity));
            }
        }

        // Camera rotation
        if (this.keys["e"]) this.cameraAngle -= this.rotationSpeed;
        if (this.keys["q"]) this.cameraAngle += this.rotationSpeed;
        const camX = this.player.position.x + Math.sin(this.cameraAngle) * this.cameraDistance;
        const camZ = this.player.position.z + Math.cos(this.cameraAngle) * this.cameraDistance;
        this.camera.position.set(camX, this.player.position.y + this.cameraHeight, camZ);
        this.camera.lookAt(this.player.position);

        // Send position to Scaledrone
        if (this.drone) {
            this.drone.publish({
                room: "observable-room",
                message: {
                    id: this.clientId,
                    x: this.player.position.x,
                    y: this.player.position.y,
                    z: this.player.position.z,
                    rotationY: this.player.rotation.y
                }
            });
        }
            // ===== WALK SOUND LOGIC =====
    if (moved && !this.walkSoundPlaying) {
        this.walkSound.loop = true; // loop walking sound
        this.walkSound.play();
        this.walkSoundPlaying = true;
    } else if (!moved && this.walkSoundPlaying) {
        this.walkSound.pause();
        this.walkSound.currentTime = 0; // reset so it starts fresh next time
        this.walkSoundPlaying = false;
    }
    
    

const fallLimit = -500; 
if (this.player.position.y < fallLimit) {
    // Reset player to spawn
    this.player.position.set(0, 5, 0); 
    this.velocity_y = 0;
    this.isJumping = false;


    this.item = 0;
    const inventoryImg = document.getElementById("inventoryItem");
    inventoryImg.style.display = "none";

    console.log("You fell too far and died! Respawning...");
}
    
    
    
    
    
    
    }

    animate() {
        requestAnimationFrame(() => this.animate());
        this.updateMovement();
        this.renderer.render(this.scene, this.camera);

    }

    addResizeListener() {
        window.addEventListener('resize', () => {
            this.camera.aspect = window.innerWidth / window.innerHeight;
            this.camera.updateProjectionMatrix();
            this.renderer.setSize(window.innerWidth, window.innerHeight);
        });
    }
}

new MultiplayerEngine();
</script>
<style>#bottomImage {
  position: fixed;          /* overlay on top of canvas */
  top: 50%;                 /* vertical center */
  left: 50%;                /* horizontal center */
  transform: translate(70%, 200%);  /* true center */
  width: 400px;             /* make it bigger */
  height: auto;             /* maintain aspect ratio */
  z-index: 10;              /* above canvas */
}</style>

<div id="inventory" 
     style="
            position: fixed;
        bottom: 10vh;             /* 5% from bottom of screen */
        right: 24vw;              /* 5% from right of screen */
        display: flex;
        flex-direction: row;     /* horizontal row */
        gap: 1vw;                /* space between items */
        z-index: 1000;           /* above canvas */
        flex-wrap: nowrap;       /* keep in one row */
     ">
    <img id="inventoryItem" 
         src="https://github.com/Maideo-Studio/textures/blob/main/00aed48c-afec-47c5-ba3b-c3f107e4298a%20(1).png?raw=true" 
         style="width: 80px; max-width: 80px; display: none;">
</div>


         
<img id="bottomImage" src="https://github.com/Maideo-Studio/textures/blob/main/output-onlinepngtools%20(3).png?raw=true">

 
</body>

</html>
